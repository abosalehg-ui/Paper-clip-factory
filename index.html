<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>مصنع مشابك الورق</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%;touch-action:manipulation}
        body{
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: url('background.webp');
            background-size: cover;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: center center;
            background-color: #071033;
            background-blend-mode: multiply;
            color:#e6eef8;
            padding:8px;
            min-height:100vh;
            -webkit-font-smoothing:antialiased;
            overflow-x:hidden;
            transition: box-shadow 1s ease-in-out; /* خاصية الانتقال لتأثيرات الإنجاز */
            position: relative; /* لتمكين وضع الكؤوس بشكل مطلق */
        }
        .container{max-width:1200px;margin:0 auto}
        .header{
            display: flex; /* يجعل العناصر (الأيقونة والنص) على سطر واحد */
            justify-content: center; /* لتوسيط الأيقونة والنص معاً أفقياً */
            align-items: center; /* لتوسيط الأيقونة والنص عمودياً (للتساوي في الارتفاع) */
            margin:6px 0 10px;
        }
        .title{
            font-size:1.3rem;
            color:#7dd3fc;
            font-weight:700;
            margin-top:0; /* إلغاء الهامش العلوي لضمان التوسيط الأفقي */
            margin-right: 8px; /* إضافة مسافة فاصلة بين الأيقونة والنص */
        }
        .subtitle{color:#9aa4b2;margin-top:3px;font-size:0.75rem}

        /* Guide button */
        .guide-btn{
            position: fixed; /* لتثبيته على الشاشة */
            top: 8px; /* مسافة من الأعلى */
            right: auto; /* إزالة أي تأثير سابق للزاوية اليمنى */
            left: 8px; /* مسافة من اليسار */
            z-index: 55; /* لضمان ظهوره فوق باقي المحتوى */
            
            background:linear-gradient(135deg,#1e40af,#3b82f6);
            border:none;
            width:30px; /* زيادة بسيطة في الحجم لتحسين اللمس */
            height:30px;
            border-radius:50%;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 3px 8px rgba(59,130,246,0.4);
            transition:transform .2s ease;
        }
        .guide-btn:active{transform:scale(0.95)}
        .guide-btn svg{width:18px;height:18px} /* زيادة حجم الأيقونة */

        /* Stats grid - 4 items in one row */
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:10px}
        .stat-card{
            background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            padding:5px;
            border-radius:8px;
            border:1px solid rgba(255,255,255,0.06);
            backdrop-filter:blur(4px);
            box-shadow:0 3px 12px rgba(2,6,23,0.5);
            text-align:center;
        }
        .stat-icon{
            width:24px;
            height:24px;
            margin:0 auto 3px;
            display:grid;
            place-items:center;
            border-radius:6px;
            background:rgba(255,255,255,0.03);
        }
        .stat-label{color:#9aa4b2;font-size:0.6rem;margin-bottom:2px}
        .stat-value{font-size:0.85rem;font-weight:700}

        /* Main sections */
        .main-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
        .section{
            background:linear-gradient(145deg,#0f1724,#1a1f2e);
            padding:8px;
            border-radius:10px;
            border:1px solid rgba(125,211,252,0.08);
            box-shadow:0 6px 20px rgba(0,0,0,0.4);
        }
        .section-title{
            font-size:0.85rem;
            font-weight:700;
            margin-bottom:6px;
            display:flex;
            align-items:center;
            gap:5px;
            justify-content:center;
        }

        /* Buttons */
        .icon-btn{
            width:100%;
            min-height:45px;
            border:none;
            border-radius:10px;
            cursor:pointer;
            transition:all .2s ease;
            position:relative;
            overflow:hidden;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:3px;
            padding:6px;
            box-shadow:0 4px 15px rgba(0,0,0,0.3);
            font-weight:700;
            font-size:0.75rem;
        }
        .icon-btn:active:not(:disabled){transform:scale(0.97)}
        .icon-btn:disabled{opacity:.4;cursor:not-allowed}
        .icon-btn svg{width:22px;height:22px;transition:transform .2s}
        .icon-btn:active:not(:disabled) svg{transform:scale(1.1)}

        .btn-make{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff}
        .btn-make:before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);opacity:0;transition:opacity .2s}
        .btn-make:active:not(:disabled):before{opacity:1}
        .btn-sell{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff}
        .btn-buy{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
        .btn-upgrade{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff}
        .btn-marketing{background:linear-gradient(135deg,#a855f7,#9333ea);color:#fff}
        .btn-secondary{background:linear-gradient(135deg,#1e3a8a,#1e40af);color:#fff}

        /* Item boxes */
        .item-box{
            background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
            padding:6px;
            border-radius:8px;
            margin-bottom:6px;
            border:1px solid rgba(255,255,255,0.04);
        }
        .item-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:5px;
            font-size:0.7rem;
        }
        .item-info{
            color:#9aa4b2;
            font-size:0.65rem;
            margin-bottom:5px;
            text-align:center;
        }

        /* Price controls */
        .price-display{
            text-align:center;
            margin-bottom:6px;
            padding:6px;
            background:rgba(16,185,129,0.1);
            border-radius:8px;
            border:1px solid rgba(16,185,129,0.2);
        }
        .price-label{color:#9aa4b2;font-size:0.65rem;margin-bottom:2px}
        .price-value{font-size:1.2rem;font-weight:700;color:#10b981}

        .price-control{display:grid;grid-template-columns:1fr 1fr;gap:5px}
        .price-btn{
            min-height:40px;
            border:none;
            border-radius:8px;
            background:linear-gradient(135deg,#0d9488,#0f766e);
            color:#fff;
            font-size:0.9rem;
            font-weight:700;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:2px;
            box-shadow:0 3px 10px rgba(13,148,136,0.3);
            transition:transform .2s;
        }
        .price-btn:active{transform:scale(0.95)}
        .price-btn svg{width:18px;height:18px}
        .price-btn span{font-size:0.65rem;opacity:0.9}

        /* Toggle */
        .toggle-container{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:6px;
            background:rgba(255,255,255,0.02);
            border-radius:8px;
            margin-bottom:6px;
            font-size:0.7rem;
        }
        .toggle-btn{
            width:45px;
            height:24px;
            border-radius:12px;
            border:none;
            cursor:pointer;
            position:relative;
            transition:background .3s;
            box-shadow:inset 0 2px 6px rgba(0,0,0,0.3);
        }
        .toggle-on{background:#10b981}
        .toggle-off{background:#475569}
        .toggle-btn:after{
            content:'';
            position:absolute;
            width:18px;
            height:18px;
            border-radius:50%;
            background:#fff;
            top:3px;
            transition:right .3s;
            box-shadow:0 2px 4px rgba(0,0,0,0.3);
        }
        .toggle-off:after{right:24px}
        .toggle-on:after{right:3px}

        /* Stats section */
        .stats-section{
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:6px;
        }
        .stat-item{text-align:center;padding:5px}
        .stat-item-label{color:#9aa4b2;font-size:0.6rem;margin-bottom:2px}
        .stat-item-value{font-size:0.85rem;font-weight:700}

        /* Animations */
        .pulse{animation:pulse 2s infinite}
        @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
        .float{animation:float 3.4s ease-in-out infinite}
        @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-5px)}100%{transform:translateY(0)}}
        .glow-update{animation:glow .9s ease}
        @keyframes glow{0%{box-shadow:0 0 0 rgba(125,211,252,0)}50%{box-shadow:0 0 15px rgba(125,211,252,0.4)}100%{box-shadow:0 0 0 rgba(125,211,252,0)}}

        /* Modal */
        .modal{
            display:none;
            position:fixed;
            inset:0;
            background:rgba(2,6,23,0.95);
            align-items:center;
            justify-content:center;
            padding:12px;
            z-index:60;
            backdrop-filter:blur(8px);
        }
        .modal.active{display:flex}
        .modal-content{
            background:linear-gradient(145deg,#071022,#0a1628);
            padding:16px;
            border-radius:12px;
            border:2px solid rgba(125,211,252,0.1);
            max-width:500px;
            width:100%;
            max-height:90vh;
            overflow:auto;
        }
        .modal-title{
            text-align:center;
            color:#7dd3fc;
            margin-bottom:12px;
            font-size:1.3rem;
        }
        .guide-section{
            background:#061427;
            padding:10px;
            border-radius:10px;
            margin-bottom:10px;
            border:1px solid rgba(255,255,255,0.04);
        }
        .guide-section h3{
            color:#60a5fa;
            margin-bottom:6px;
            font-size:0.9rem;
        }
        .guide-section ul,.guide-section p{
            list-style:none;
            padding:0;
            color:#cbd5e1;
            font-size:0.8rem;
            line-height:1.5;
        }
        .guide-section ul li{margin-bottom:5px}

        .dev-info{
            text-align:center;
            padding:10px;
            border-radius:8px;
            background:linear-gradient(90deg,#071433,#0b1b2c);
            border:1px solid rgba(125,211,252,0.06);
            margin-top:10px;
            font-size:0.8rem;
        }
        
        /* New Challenge Modal Styles */
        /* تعديل تصميم مودال الحوادث ليتطابق مع modal الرئيسي */
        #challengeModal .modal-content {
            border: 2px solid rgba(239, 68, 68, 0.4); /* لون أحمر باهت للحافة */
            background: linear-gradient(145deg, #071022,#0a1628); /* نفس خلفية المودال الرئيسية */
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); /* ظل أحمر للتنبيه */
        }
        #challengeModal .modal-title {
            color: #ef4444; /* لون أحمر للعنوان */
            font-weight: 700;
        }
        #challengeModal .modal-content strong {
            color: #fca5a5;
        }
        
        /* Game Over Modal Styles - New */
        #gameOverModal .modal-content {
            border: 2px solid rgba(255, 255, 255, 0.4);
            background: linear-gradient(145deg, #071022,#0a1628);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        #insuranceTimer {
            text-align: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fca5a5;
            margin-top: -6px;
            margin-bottom: 6px;
        }


        /* TROPHY Styles - Full Page Glow */
        .trophy-bronze {
            box-shadow: 0 0 30px 10px rgba(176, 141, 87, 0.7), inset 0 0 20px rgba(176, 141, 87, 0.5);
        }
        .trophy-silver {
            box-shadow: 0 0 40px 15px rgba(192, 192, 192, 0.8), inset 0 0 30px rgba(192, 192, 192, 0.6);
        }
        .trophy-gold {
            box-shadow: 0 0 50px 20px rgba(255, 215, 0, 0.9), inset 0 0 40px rgba(255, 215, 0, 0.7);
        }

        /* TROPHY Icon Styles (PNG Version) */
        .trophy-icon {
            position: fixed;
            top: 8px;
            right: 8px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 50;
            display: none; /* مخفي افتراضياً */
            animation: bounceIn 0.8s ease-out forwards;
            background: transparent;

            /* خصائص PNG */
            background-size: 25px 25px; /* حجم الأيقونة الداخلية - كان 25px للسفج */
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Bronze Trophy Icon - Use background-image for PNG and gradient for color */
        #trophyBronzeIcon {
            background-image: url('trophy-bronze.png');
        }

        /* Silver Trophy Icon */
        #trophySilverIcon {
            background-image: url('trophy-silver.png');
        }

        /* Gold Trophy Icon */
        #trophyGoldIcon {
            background-image: url('trophy-gold.png');
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Tablet & Desktop */
        @media (min-width:768px){
            .stats-grid{gap:12px}
            .stat-card{padding:10px}
            .stat-icon{width:40px;height:40px;margin-bottom:6px}
            .stat-label{font-size:0.8rem;margin-bottom:3px}
            .stat-value{font-size:1.2rem}
            .main-grid{grid-template-columns:repeat(2,1fr);gap:16px}
            .section{padding:14px}
            .title{font-size:2rem}
            .icon-btn{min-height:70px;font-size:0.9rem}
            .icon-btn svg{width:35px;height:35px}
            .section-title{font-size:1rem}
        }
    </style>
</head>
<body>
            <button class="guide-btn" onclick="toggleGuide()">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="#fff" stroke-width="2"/>
                    <path d="M12 16v-4M12 8h.01" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
    <audio id="clickSound" src="click.mp3" preload="auto"></audio>
    <audio id="cashSound" src="cash.mp3" preload="auto"></audio>
    <audio id="buySound" src="buy.mp3" preload="auto"></audio>
    <audio id="trophySound" src="Trophy.Mp3" preload="auto"></audio>
    <audio id="warningSound" src="warning.mp3" preload="auto"></audio>
    <audio id="fireSound" src="fire.mp3" preload="auto"></audio>
    <audio id="failSound" src="fail.mp3" preload="auto"></audio> <div id="trophyBronzeIcon" class="trophy-icon"></div>
    <div id="trophySilverIcon" class="trophy-icon"></div>
    <div id="trophyGoldIcon" class="trophy-icon"></div>

    <div class="container">
        <div class="header">
            <svg class="title-icon float" width="32" height="32" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                        <stop offset="0" stop-color="#7dd3fc"/>
                        <stop offset="1" stop-color="#60a5fa"/>
                    </linearGradient>
                </defs>
                <path d="M20 14 C20 10,24 10,26 10 L44 10 C50 10,52 14,52 18 L52 46 C52 56,42 58,36 52 L30 46 C26 42,26 36,30 32 L42 20" fill="none" stroke="url(#g1)" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="title">مصنع مشابك الورق</h1>
        </div>

        <div class="stats-grid">
            <div class="stat-card" id="card-clips">
                <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <path d="M44 16 C44 12,40 10,36 12 L24 18 C18 21,18 30,24 33 L36 38 C44 43,52 36,44 28 L28 12" stroke="#60a5fa" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="stat-label">المشابك</div>
                <div class="stat-value" id="clips">0</div>
            </div>

            <div class="stat-card" id="card-money">
                <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="32" cy="32" r="20" fill="#10b981" opacity="0.3"/>
                        <text x="32" y="40" font-size="28" font-weight="bold" fill="#10b981" text-anchor="middle">$</text>
                    </svg>
                </div>
                <div class="stat-label">المال</div>
                <div class="stat-value">$<span id="money">0.00</span></div>
            </div>

            <div class="stat-card" id="card-wire">
                <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="32" cy="28" r="12" fill="#f59e0b"/>
                        <circle cx="32" cy="28" r="7" fill="#0b1320"/>
                    </svg>
                </div>
                <div class="stat-label">السلك</div>
                <div class="stat-value" id="wire">1000</div>
            </div>

            <div class="stat-card" id="card-demand">
                <div class="stat-icon">
                    <svg width="20" height="20" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="12,44 24,30 36,36 50,20" fill="none" stroke="#a78bfa" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="50" cy="20" r="3.4" fill="#a78bfa"/>
                    </svg>
                </div>
                <div class="stat-label">الطلب</div>
                <div class="stat-value" id="demand">50</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="section">
                <div class="section-title" style="color:#7dd3fc">
                    <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 13h6v8H3zM15 3h6v18h-6zM9 7h6v14H9z" fill="#7dd3fc" opacity="0.3"/>
                    </svg>
                    الإنتاج
                </div>

                <button id="makeBtn" class="icon-btn btn-make" onclick="makeClip()">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <path d="M20 14 C20 10,24 10,26 10 L44 10 C50 10,52 14,52 18 L52 46 C52 56,42 58,36 52 L30 46 C26 42,26 36,30 32 L42 20" stroke="#fff" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span id="makeBtnText">صنع مشبك</span>
                </button>

                <div class="item-box">
                    <div class="item-header">
                        <span>آلات صنع تلقائي</span>
                        <span style="color:#60a5fa;font-weight:700" id="autoClippers">0</span>
                    </div>
                    <div class="item-info">
                        معدل الإنتاج: <span id="autoRate">0</span>/ثانية
                    </div>
                    <button id="autoClipperBtn" class="icon-btn btn-secondary" onclick="buyAutoClipper()">
                        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                            <rect x="10" y="22" width="44" height="20" rx="4" fill="rgba(255,255,255,0.2)"/>
                            <rect x="18" y="28" width="28" height="8" fill="#60a5fa"/>
                            <circle cx="14" cy="46" r="6" fill="#60a5fa"/>
                            <circle cx="50" cy="46" r="6" fill="#60a5fa"/>
                            <path d="M26 22l-4-8h20l-4 8" fill="#fff"/>
                        </svg>
                        <span>شراء آلة $<span id="autoClipperCost">5.00</span></span>
                    </button>
                </div>

                <div class="item-box">
                    <div class="item-header">
                        <span>شراء سلك (1000 وحدة)</span>
                        <span style="color:#f59e0b;font-weight:700">$<span id="wireCost">20.00</span></span>
                    </div>
                    <button id="wireBtn" class="icon-btn btn-buy" onclick="buyWire()">
                        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                            <path d="M32 10c11 0 20 9 20 20 0 11-9 20-20 20S12 41 12 30c0-11 9-20 20-20z" fill="#f59e0b" opacity="0.3"/>
                            <path d="M44 30A12 12 0 0132 42V30h12z" fill="#d97706"/>
                            <path d="M32 18A12 12 0 0032 42V18z" stroke="#fff" stroke-width="2" fill="none"/>
                            <circle cx="32" cy="30" r="4" fill="#fff"/>
                        </svg>
                        <span>شراء سلك</span>
                    </button>
                </div>
            </div>

            <div class="section">
                <div class="section-title" style="color:#86efac">
                    <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 7h16M4 11h12" stroke="#86efac" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    المبيعات
                </div>

                <div class="price-display">
                    <div class="price-label">السعر</div>
                    <div class="price-value">$<span id="price">0.25</span></div>
                </div>

                <div class="price-control">
                    <button class="price-btn" onclick="adjustPrice(-0.01)">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                            <path d="M5 12h14" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                        <span>تخفيض</span>
                    </button>
                    <button class="price-btn" onclick="adjustPrice(0.01)">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                            <path d="M12 5v14M5 12h14" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                        <span>زيادة</span>
                    </button>
                </div>

                <button id="sellBtn" class="icon-btn btn-sell" onclick="sellClips()" style="margin-top:6px">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <rect x="10" y="16" width="44" height="38" rx="4" fill="rgba(255,255,255,0.1)"/>
                        <path d="M14 16v-6h36v6M32 40v-8M24 40v-8M40 40v-8" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                        <rect x="28" y="24" width="8" height="8" fill="#fff"/>
                        <path d="M10 54h44" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                    <span>بيع المشابك (متوفر: <span id="availableClips">0</span>)</span>
                </button>

                <div class="toggle-container">
                    <span>بيع تلقائي</span>
                    <button id="autoSellBtn" class="toggle-btn toggle-off" onclick="toggleAutoSell()"></button>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title" style="color:#fbbf24">
                <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 3l9 9-9 9-9-9z" fill="#fbbf24" opacity="0.3"/>
                </svg>
                الترقيات
            </div>

            <div class="item-box">
                <div class="item-header">
                    <span>توسعة المصنع لـ 100 آلة جديدة</span>
                    <span style="color:#7dd3fc;font-weight:700">الحد الأقصى: <span id="maxClippers">100</span></span>
                </div>
                <button id="expansionBtn" class="icon-btn btn-secondary" onclick="buyExpansion()">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <rect x="8" y="10" width="48" height="44" rx="4" stroke="#fff" stroke-width="3" opacity="0.4"/>
                        <rect x="18" y="20" width="28" height="24" rx="2" stroke="#fff" stroke-width="3" fill="#60a5fa" opacity="0.7"/>
                        <path d="M32 10v44M8 32h48" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                    <span> $<span id="expansionCost">2000.00</span></span>
                </button>
            </div>
            
            <div class="item-box">
                <div class="item-header">
                    <span>ترقية التسويق</span>
                    <span style="color:#a78bfa;font-weight:700">المستوى <span id="marketingLevel">1</span></span>
                </div>
                <button id="marketingBtn" class="icon-btn btn-marketing" onclick="increaseMarketing()">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <path d="M12 36l8-8 12 12-8 8z" fill="rgba(255,255,255,0.2)"/>
                        <path d="M20 28l-8 8v-8h8zM40 28l12-12v32L40 40v-4" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="40" cy="32" r="4" fill="#fff"/>
                        <path d="M48 20l4-4M48 44l4 4" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span> $<span id="marketingCost">100.00</span></span>
                </button>
            </div>
            <div class="item-box">
                <div class="item-header">
                    <span>تأمين المصنع من الحوادث لمدة 5 دقائق</span>
                    <span style="color:#8b5cf6;font-weight:700">المستوى <span id="insuranceLevel">0</span></span>
                </div>
                <div id="insuranceTimer"></div>
                <button id="insuranceBtn" class="icon-btn btn-upgrade" onclick="buyInsurance()">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <path d="M32 54C46.3594 54 58 42.3594 58 28V10L32 6L6 10V28C6 42.3594 17.6406 54 32 54Z" fill="#8b5cf6" opacity="0.3"/>
                        <path d="M32 54C46.3594 54 58 42.3594 58 28M32 54C17.6406 54 6 42.3594 6 28" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M32 30V40" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                        <circle cx="32" cy="24" r="3" fill="#fff"/>
                    </svg>
                    <span> $<span id="insuranceCost">1000.00</span></span>
                </button>
            </div>
            <div class="item-box">
                <div class="item-header">
                    <span>زيادة كفاءة السلك</span>
                    <span style="color:#fbbf24;font-weight:700">×<span id="wireEfficiency">1.0</span></span>
                </div>
                <button id="efficiencyBtn" class="icon-btn btn-upgrade" onclick="buyWireEfficiency()">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <path d="M32 12v-4M32 56v-4M12 32h-4M56 32h-4M16 16l-3-3M51 51l-3-3M16 48l-3 3M51 13l-3 3" stroke="#fff" stroke-width="4" stroke-linecap="round"/>
                        <circle cx="32" cy="32" r="14" stroke="#fff" stroke-width="4"/>
                        <circle cx="32" cy="32" r="5" fill="#fff"/>
                    </svg>
                    <span> $<span id="efficiencyCost">1000.00</span></span>
                </button>
            </div>
        </div>

        <div class="section">
            <div class="section-title" style="color:#cbd5e1">
                <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="8" width="4" height="13" rx="1" fill="#93c5fd"/>
                    <rect x="10" y="3" width="4" height="18" rx="1" fill="#60a5fa"/>
                    <rect x="17" y="12" width="4" height="9" rx="1" fill="#7dd3fc"/>
                </svg>
                الإحصائيات
            </div>
            <div class="stats-section">
                <div class="stat-item">
                    <div class="stat-item-label">إجمالي الإنتاج</div>
                    <div class="stat-item-value" id="totalClips">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">إجمالي المبيعات</div>
                    <div class="stat-item-value" id="totalSold">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">الآلات</div>
                    <div class="stat-item-value" id="totalMachines">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">معدل الإنتاج</div>
                    <div class="stat-item-value"><span id="productionRate">0</span>/ث</div>
                </div>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" style="color: #ef4444;">انتهت اللعبة! 🛑</h2>
            <p style="text-align:center;color:#cbd5e1;margin-bottom:15px;" id="gameOverMessage">
                لقد نفد منك السلك ولا تملك المال الكافي لشراء المزيد، ولا يوجد لديك مشابك لبيعها.
            </p>
            <div class="dev-info" style="margin-top:0; border:none; background:none;">
                <div style="font-weight:700;color:#e6eef8">النقاط النهائية: $<span id="finalMoney">0.00</span></div>
                <div style="margin-top:3px; font-size:0.75rem; color:#9aa4b2">تم بيع: <span id="finalSold">0</span> مشبك</div>
            </div>
            <button class="icon-btn btn-make" onclick="location.reload()" style="width:100%;background:linear-gradient(135deg,#2563eb,#1d4ed8); margin-top:15px;">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                    <path d="M12 4v16M5 11l7-7 7 7" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>إعادة اللعب</span>
            </button>
        </div>
    </div>
    
    <div id="challengeModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="challengeTitle">حادث!</h2>
            <p style="text-align:center;color:#cbd5e1;margin-bottom:15px;" id="challengeMessage">
                تمت سرقة 500 دولار من المصنع بسبب ثغرة أمنية!
            </p>
            <button class="icon-btn btn-make" onclick="closeChallengeModal()" style="width:100%;background:linear-gradient(135deg,#ef4444,#dc2626)">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                    <path d="M6 18L18 6M6 6l12 12" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>حسناً</span>
            </button>
        </div>
    </div>
    
    <div id="guideModal" class="modal">
        <div class="modal-content">

            <div class="guide-section">
                <h3>🎮 كيفية اللعب</h3>
                <ul>
                    <li>• اضغط صنع مشبك لصنع مشبك واحد (يستهلك سلك).</li>
                    <li>• بع المشابك لتحصل على المال. السعر يؤثر على الطلب.</li>
                    <li>• اشترِ سلك وآلات لترفع الإنتاجية، ووسع مصنعك.</li>
                </ul>
            </div>

            <div class="guide-section">
                <h3>⚡ الأتمتة</h3>
                <ul>
                    <li>• الآلة تنتج مشابك كل ثانية.</li>
                    <li>• فعّل البيع التلقائي للبيع بدون ضغط منك.</li>
                </ul>
            </div>

            <div class="guide-section">
                <h3>🚀 الترقيات</h3>
                <ul>
                    <li>• زيادة كفاءة السلك تعطيك سلك أكثر عند الشراء.</li>
                    <li>• التسويق يزيد الطلب على منتجاتك.</li>
                    <li>• التأمين يقفل الحوادث السرقة والحريق مؤقتاً.</li>
                    <li>• توسعة المصنع تتيح مساحة لآلات صنع تلقائي إضافية.</li>
                </ul>
            </div>

            <div class="dev-info">
                <div style="font-weight:700;color:#e6eef8">المطور — ABDULKARIM ALOBUD</div>
                <div style="margin-top:6px"><a href="mailto:abo.saleh.g@gmail.com" style="color:#60a5fa;text-decoration:none">abo.saleh.g@gmail.com</a></div>
            </div>

            <div style="margin-top:16px">
                <button class="icon-btn btn-make" onclick="toggleGuide()" style="width:100%">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none">
                        <path d="M5 12h14M12 5l7 7-7 7" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>ابدأ اللعب</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            clips: 0,
            money: 0,
            price: 0.25,
            demand: 50,
            wire: 1000,
            wireCost: 20,
            autoClippers: 0,
            autoClipperCost: 5,
            autoClipperRate: 0,
            wireEfficiency: 1,
            marketingLevel: 1,
            autoSellEnabled: false,
            totalClips: 0,
            totalSold: 0,
            // الإضافات الجديدة
            insuranceLevel: 0,
            insuranceCost: 1000,
            insuranceEndTime: 0, // Timestamp of when insurance expires
            maxClippersLimit: 100, // NEW: الحد الأقصى لآلات الصنع
            expansionCost: 2000, // NEW: تكلفة التوسعة الأولية
            // حالة الإنجازات
            trophyBronze: false,
            trophySilver: false,
            trophyGold: false
        };

        const clickSound = document.getElementById('clickSound');
        const cashSound = document.getElementById('cashSound');
        const buySound = document.getElementById('buySound');
        const trophySound = document.getElementById('trophySound');
        const warningSound = document.getElementById('warningSound');
        const fireSound = document.getElementById('fireSound');
        const failSound = document.getElementById('failSound'); // NEW: Fail Sound


        // عناصر الكؤوس
        const trophyBronzeIcon = document.getElementById('trophyBronzeIcon');
        const trophySilverIcon = document.getElementById('trophySilverIcon');
        const trophyGoldIcon = document.getElementById('trophyGoldIcon');
        
        // عناصر الحوادث
        const challengeModal = document.getElementById('challengeModal');
        const challengeTitle = document.getElementById('challengeTitle');
        const challengeMessage = document.getElementById('challengeMessage');
        const insuranceTimerEl = document.getElementById('insuranceTimer');
        
        // عناصر الخسارة (NEW)
        const gameOverModal = document.getElementById('gameOverModal');
        const finalMoneyEl = document.getElementById('finalMoney');
        const finalSoldEl = document.getElementById('finalSold');

        function playSound(audioElement) {
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.error("Error playing sound:", e));
        }

        function flash(id){
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.add('glow-update');
            setTimeout(()=>el.classList.remove('glow-update'),900);
        }
        
        // NEW: Game Over Check
        function checkGameOver() {
            // شرط الخسارة: لا يوجد سلك AND المال < تكلفة السلك AND لا يوجد مشابك للبيع
            if (gameState.wire === 0 && gameState.money < gameState.wireCost && gameState.clips === 0) {
                
                finalMoneyEl.textContent = gameState.money.toFixed(2);
                finalSoldEl.textContent = gameState.totalSold.toLocaleString();
                
                gameOverModal.classList.add('active');
                playSound(failSound); // تشغيل صوت الخسارة
                
                // إيقاف جميع الأزرار لمنع أي تفاعل آخر عدا "إعادة اللعب"
                document.querySelectorAll('button').forEach(btn => btn.disabled = true);
                document.getElementById('autoSellBtn').disabled = true;
                document.querySelector('.guide-btn').style.display = 'none';

                console.log("Game Over: Stuck without clips or wire!");
                return true;
            }
            return false;
        }

        function checkTrophy(newTotalSold) {
            const body = document.body;

            // إخفاء جميع الكؤوس أولاً
            trophyBronzeIcon.style.display = 'none';
            trophySilverIcon.style.display = 'none';
            trophyGoldIcon.style.display = 'none';

            // إزالة جميع تأثيرات الجسم أولاً
            body.classList.remove('trophy-bronze', 'trophy-silver', 'trophy-gold');


            // إنجاز برونزي (1000 مبيعة)
            if (!gameState.trophyBronze && newTotalSold >= 1000) {
                gameState.trophyBronze = true;
                body.classList.add('trophy-bronze');
                trophyBronzeIcon.style.display = 'flex';
                playSound(trophySound);
                console.log("Trophy Unlocked: Bronze (1,000 Clips Sold)");
            }
            // إذا كان الإنجاز البرونزي محققًا بالفعل ولم يتم تحقيق الفضي أو الذهبي بعد
            else if (gameState.trophyBronze && newTotalSold < 10000) {
                body.classList.add('trophy-bronze');
                trophyBronzeIcon.style.display = 'flex';
            }


            // إنجاز فضي (10000 مبيعة)
            if (!gameState.trophySilver && newTotalSold >= 10000) {
                gameState.trophySilver = true;
                body.classList.add('trophy-silver');
                trophySilverIcon.style.display = 'flex';
                playSound(trophySound);
                console.log("Trophy Unlocked: Silver (10,000 Clips Sold)");
            }
            // إذا كان الإنجاز الفضي محققًا بالفعل ولم يتم تحقيق الذهبي بعد
            else if (gameState.trophySilver && newTotalSold < 100000) {
                body.classList.add('trophy-silver');
                trophySilverIcon.style.display = 'flex';
            }


            // إنجاز ذهبي (100000 مبيعة)
            if (!gameState.trophyGold && newTotalSold >= 100000) {
                gameState.trophyGold = true;
                body.classList.add('trophy-gold');
                trophyGoldIcon.style.display = 'flex';
                playSound(trophySound);
                console.log("Trophy Unlocked: Gold (100,000 Clips Sold)");
            }
            // إذا كان الإنجاز الذهبي محققًا بالفعل
            else if (gameState.trophyGold) {
                body.classList.add('trophy-gold');
                trophyGoldIcon.style.display = 'flex';
            }
        }

        // تحديث عرض مؤقت التأمين
        function updateInsuranceTimer() {
            const remainingTime = gameState.insuranceEndTime - Date.now();
            const insuranceBtn = document.getElementById('insuranceBtn');
            const insuranceCostSpan = document.getElementById('insuranceCost');

            if (remainingTime > 0) {
                const minutes = Math.floor(remainingTime / 60000);
                const seconds = Math.floor((remainingTime % 60000) / 1000);
                insuranceTimerEl.textContent = `التأمين نشط: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                insuranceTimerEl.style.display = 'block';
                // أثناء نشاط التأمين، لا يمكن الشراء ولكنه لا يزال يظهر التكلفة التالية
                insuranceBtn.disabled = true;
            } else {
                gameState.insuranceEndTime = 0; // تأكد من أن الوقت ينتهي
                insuranceTimerEl.textContent = '';
                insuranceTimerEl.style.display = 'none';
                insuranceBtn.disabled = gameState.money < gameState.insuranceCost; // أعد تفعيل الزر إذا كان لديه مال
            }
            
            insuranceCostSpan.textContent = gameState.insuranceCost.toFixed(2);
        }
        
        // مؤقت تحديث التأمين
        setInterval(updateInsuranceTimer, 1000);


        function updateUI(){
            document.getElementById('clips').textContent = gameState.clips.toLocaleString();
            document.getElementById('money').textContent = gameState.money.toFixed(2);
            document.getElementById('wire').textContent = gameState.wire.toLocaleString();
            document.getElementById('demand').textContent = gameState.demand;
            document.getElementById('price').textContent = gameState.price.toFixed(2);
            document.getElementById('autoClippers').textContent = gameState.autoClippers;
            document.getElementById('autoRate').textContent = gameState.autoClipperRate;
            document.getElementById('autoClipperCost').textContent = gameState.autoClipperCost.toFixed(2);
            document.getElementById('wireCost').textContent = gameState.wireCost.toFixed(2);
            document.getElementById('wireEfficiency').textContent = gameState.wireEfficiency.toFixed(1);
            document.getElementById('efficiencyCost').textContent = (gameState.wireEfficiency * 1000).toFixed(2);
            document.getElementById('marketingLevel').textContent = gameState.marketingLevel;
            document.getElementById('marketingCost').textContent = (gameState.marketingLevel * 100).toFixed(2);
            document.getElementById('availableClips').textContent = gameState.clips;
            document.getElementById('totalClips').textContent = gameState.totalClips.toLocaleString();
            document.getElementById('totalSold').textContent = gameState.totalSold.toLocaleString();
            document.getElementById('totalMachines').textContent = gameState.autoClippers;
            document.getElementById('productionRate').textContent = gameState.autoClipperRate;
            
            // تحديث عناصر التأمين الجديدة
            document.getElementById('insuranceLevel').textContent = gameState.insuranceLevel;
            document.getElementById('insuranceCost').textContent = gameState.insuranceCost.toFixed(2);
            
            // NEW: تحديث عناصر التوسعة
            document.getElementById('maxClippers').textContent = gameState.maxClippersLimit.toLocaleString();
            document.getElementById('expansionCost').textContent = gameState.expansionCost.toFixed(2);
            
            updateInsuranceTimer(); // تحديث خاص بحالة التأمين والزر
            
            const makeBtn = document.getElementById('makeBtn');
            makeBtn.disabled = gameState.wire < 1;
            document.getElementById('makeBtnText').textContent = gameState.wire < 1 ? 'لا يوجد سلك' : 'صنع مشبك';

            document.getElementById('sellBtn').disabled = gameState.clips === 0;
            // NEW: الحد الأقصى للآلات
            document.getElementById('autoClipperBtn').disabled = gameState.money < gameState.autoClipperCost || gameState.autoClippers >= gameState.maxClippersLimit;
            document.getElementById('wireBtn').disabled = gameState.money < gameState.wireCost;
            document.getElementById('efficiencyBtn').disabled = gameState.money < gameState.wireEfficiency * 1000;
            document.getElementById('marketingBtn').disabled = gameState.money < gameState.marketingLevel * 100;
            document.getElementById('expansionBtn').disabled = gameState.money < gameState.expansionCost; // NEW: زر التوسعة
            
            checkGameOver(); // NEW: فحص الخسارة
        }

        function makeClip(){
            if(gameState.wire >= 1){
                gameState.clips++;
                gameState.totalClips++;
                gameState.wire--;
                playSound(clickSound); // صوت صنع مشبك
                flash('card-clips');
                flash('card-wire');
                updateUI();
            }
        }

        function sellClips(){
            if(gameState.clips > 0){
                const sellAmount = Math.min(gameState.clips, gameState.demand);
                gameState.clips -= sellAmount;
                gameState.money += sellAmount * gameState.price;
                gameState.totalSold += sellAmount;
                gameState.demand = Math.max(10, gameState.demand - Math.floor(sellAmount * 0.1));
                
                if (sellAmount > 0) {
                    playSound(cashSound); // صوت بيع المشابك
                    checkTrophy(gameState.totalSold);
                }
                
                flash('card-money');
                flash('card-clips');
                updateUI();
            }
        }

        function buyWire(){
            if(gameState.money >= gameState.wireCost){
                gameState.money -= gameState.wireCost;
                gameState.wire += 1000 * gameState.wireEfficiency;
                playSound(buySound); // صوت شراء سلك
                flash('card-wire');
                flash('card-money');
                updateUI();
            }
        }

        function buyAutoClipper(){
            // NEW: إضافة شرط الحد الأقصى
            if(gameState.money >= gameState.autoClipperCost && gameState.autoClippers < gameState.maxClippersLimit){
                gameState.money -= gameState.autoClipperCost;
                gameState.autoClippers++;
                // يتم زيادة التكلفة بشكل طبيعي إذا لم نصل للحد الأقصى الحالي
                if (gameState.autoClippers % 100 !== 0) {
                    gameState.autoClipperCost = Math.floor(gameState.autoClipperCost * 1.15);
                } else {
                    // إذا وصلنا للحد الأقصى، تثبيت التكلفة مؤقتاً
                    // عند التوسعة، سيعاد تعيين التكلفة وفقاً لمنطق اللعبة
                }
                
                playSound(buySound); // صوت شراء آلة
                flash('card-clips');
                flash('card-money');
                updateUI();
            }
        }

        function adjustPrice(delta){
            gameState.price = Math.max(0.01, Math.round((gameState.price + delta)*100)/100);
            if(delta > 0) gameState.demand = Math.max(5, gameState.demand - 5);
            else gameState.demand += 5;
            flash('card-demand');
            updateUI();
        }

        function increaseMarketing(){
            const cost = gameState.marketingLevel * 100;
            if(gameState.money >= cost){
                gameState.money -= cost;
                gameState.marketingLevel++;
                gameState.demand += 20;
                playSound(buySound); 
                flash('card-demand');
                flash('card-money');
                updateUI();
            }
        }

        function buyWireEfficiency(){
            const cost = gameState.wireEfficiency * 1000;
            if(gameState.money >= cost){
                gameState.money -= cost;
                gameState.wireEfficiency += 0.5;
                playSound(buySound); 
                flash('card-wire');
                flash('card-money');
                updateUI();
            }
        }
        
        // NEW: وظيفة توسعة المصنع
        function buyExpansion(){
            const cost = gameState.expansionCost;
            if(gameState.money >= cost){
                gameState.money -= cost;
                gameState.maxClippersLimit += 100; // زيادة الحد الأقصى بمقدار 100
                gameState.expansionCost = Math.floor(gameState.expansionCost * 2); // مضاعفة تكلفة التوسعة
                
                // إعادة تعيين تكلفة الآلة التلقائية لآلة البداية الجديدة بعد التوسعة
                if (gameState.autoClippers === gameState.maxClippersLimit - 100) {
                    // يمكن هنا تعيين تكلفة الآلة الأولى في التوسعة الجديدة إذا لزم الأمر
                    // لكن المنطق الحالي لزيادة التكلفة يكفي
                }
                
                playSound(buySound); 
                flash('card-money');
                updateUI();
            }
        }
        
        // وظيفة شراء التأمين الجديدة
        function buyInsurance(){
            const cost = gameState.insuranceCost;
            if(gameState.money >= cost){
                gameState.money -= cost;
                gameState.insuranceLevel++;
                gameState.insuranceCost = gameState.insuranceLevel * 1000;
                
                // إضافة 5 دقائق (300,000 مللي ثانية)
                const now = Date.now();
                // إذا كان التأمين نشطاً، يتم تمديد الوقت. إذا لم يكن نشطاً، يبدأ الآن.
                gameState.insuranceEndTime = Math.max(gameState.insuranceEndTime, now) + 300000; 
                
                playSound(buySound); 
                flash('card-money');
                updateUI();
            }
        }

        function toggleAutoSell(){
            gameState.autoSellEnabled = !gameState.autoSellEnabled;
            const btn = document.getElementById('autoSellBtn');
            btn.className = gameState.autoSellEnabled ? 'toggle-btn toggle-on' : 'toggle-btn toggle-off';
        }

        function toggleGuide(){
            const modal = document.getElementById('guideModal');
            modal.classList.toggle('active');
        }
        
        function closeChallengeModal(){
             challengeModal.classList.remove('active');
             updateUI();
        }
        
        // منطق الحوادث العشوائية
        function triggerRandomChallenge() {
            // تحقق ما إذا كان التأمين نشطًا
            if (gameState.insuranceEndTime > Date.now()) {
                console.log("Challenge blocked by insurance!");
                return; 
            }
            
            // NEW: فرصة 10% لوقوع حادث عشوائي
            if (Math.random() < 0.10) { 
                
                let isMoneyLoss = false;
                let isClipsLoss = false;

                // سرقة: إذا كان المال > 3500
                if (gameState.money >= 3500 && Math.random() < 0.5) { 
                    isMoneyLoss = true;
                } 
                
                // حريق: إذا كانت المشابك > 4500
                else if (gameState.clips >= 4500) {
                    isClipsLoss = true;
                }

                if (isMoneyLoss) {
                    const lossAmount = 500;
                    gameState.money = Math.max(0, gameState.money - lossAmount);
                    
                    challengeTitle.textContent = "⚠️ حادث: سرقة!";
                    challengeMessage.innerHTML = `حدثت سرقة في المصنع! تم حسم <strong>$${lossAmount.toFixed(2)}</strong> من أموالك.`;
                    
                    challengeModal.classList.add('active');
                    playSound(warningSound); // تشغيل نغمة التحذير
                    flash('card-money');
                } else if (isClipsLoss) {
                    const lossAmount = 500;
                    gameState.clips = Math.max(0, gameState.clips - lossAmount);
                    
                    challengeTitle.textContent = "🔥 حادث: حريق!";
                    challengeMessage.innerHTML = `اندلع حريق في المخزن! تم حسم <strong>${lossAmount.toLocaleString()}</strong> مشبك ورقي.`;
                    
                    challengeModal.classList.add('active');
                    playSound(fireSound); // تشغيل نغمة الحريق
                    flash('card-clips');
                }
                
                updateUI();
            }
        }

        // Auto production
        setInterval(()=>{
            // NEW: إذا كانت اللعبة قد انتهت، لا تكمل الإنتاج
            if (checkGameOver()) return;
            
            if(gameState.autoClippers > 0 && gameState.wire >= gameState.autoClippers){
                gameState.clips += gameState.autoClippers;
                gameState.totalClips += gameState.autoClippers;
                gameState.wire -= gameState.autoClippers;
                gameState.autoClipperRate = gameState.autoClippers;
                flash('card-clips');
                flash('card-wire');
                updateUI();
            }
        },1000);

        // Auto sell
        setInterval(()=>{
            // NEW: إذا كانت اللعبة قد انتهت، لا تكمل البيع
            if (checkGameOver()) return;
            
            if(gameState.autoSellEnabled && gameState.clips > 0){
                const sellAmount = Math.min(gameState.clips, Math.max(1, Math.floor(gameState.demand * 0.1)), 10);
                gameState.clips -= sellAmount;
                gameState.money += sellAmount * gameState.price;
                gameState.totalSold += sellAmount;
                
                if (sellAmount > 0) {
                    playSound(cashSound); // صوت بيع المشابك للبيع التلقائي
                    checkTrophy(gameState.totalSold);
                }

                flash('card-money');
                flash('card-clips');
                updateUI();
            }
        },2000);

        // Restore demand and check random challenges
        setInterval(()=>{
            // NEW: إذا كانت اللعبة قد انتهت، لا تكمل التحديثات
            if (checkGameOver()) return;
            
            // تحديث الطلب
            gameState.demand = Math.min(100 * gameState.marketingLevel, gameState.demand + gameState.marketingLevel);
            
            // تحقق من الحوادث العشوائية كل 3 ثوان (بالتزامن مع تحديث الطلب)
            triggerRandomChallenge();
            
            updateUI();
        },3000);

        // قم بفتح نافذة الدليل عند أول تحميل
        window.onload = function() {
            toggleGuide();
            // لضمان عرض أي كأس تم تحقيقه بعد تحميل الصفحة (إذا كانت البيانات محفوظة)
            checkTrophy(gameState.totalSold); 
            updateUI();
        }
    </script>
</body>
</html>
